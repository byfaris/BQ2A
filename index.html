<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>QB2A | ثبات كامل</title>
    <style>
        :root { --blue: #00f2ff; --red: #ff0044; }
        
        /* تعطيل التكبير والإيماءات نهائياً */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #000; 
            touch-action: none; /* يمنع التكبير الافتراضي */
            -webkit-user-select: none; /* منع تحديد النص */
            user-select: none;
            -webkit-touch-callout: none; /* منع القائمة المنبثقة في iOS */
        }
        
        canvas { display: block; width: 100%; height: 100%; touch-action: none; }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10; font-family: sans-serif;
            padding: 20px; box-sizing: border-box;
        }
        .stat { color: var(--blue); font-weight: bold; font-size: 18px; }

        .ctrl-zone {
            position: absolute; bottom: 30px; width: 100%; height: 150px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; box-sizing: border-box; pointer-events: none;
        }
        
        .joy-area {
            width: 120px; height: 120px; background: rgba(0,242,255,0.1);
            border: 2px solid var(--blue); border-radius: 50%; 
            pointer-events: auto; position: relative; touch-action: none;
        }
        
        #stick {
            width: 50px; height: 50px; background: var(--blue); 
            border-radius: 50%; position: absolute; top: 35px; left: 35px;
            pointer-events: none;
        }
        
        .fire-btn {
            width: 90px; height: 90px; background: rgba(255,0,68,0.2);
            border: 3px solid var(--red); border-radius: 50%;
            color: white; display: flex; align-items: center; justify-content: center;
            font-weight: bold; pointer-events: auto; touch-action: none;
        }

        #start-screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; color: white; text-align: center; touch-action: none;
        }
        .card {
            border: 2px solid var(--blue); padding: 15px; margin: 10px; width: 200px;
            cursor: pointer; background: rgba(255,255,255,0.05); pointer-events: auto;
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:var(--blue)">QB2A: ثورة البشر</h1>
        <div class="card" onclick="startGame('assault')">فصيل المهاجم</div>
        <div class="card" onclick="startGame('hacker')">فصيل الهاكر</div>
    </div>

    <div id="ui-layer">
        <div class="stat" id="score">النقاط: 0</div>
    </div>

    <div class="ctrl-zone">
        <div class="joy-area" id="joy-base">
            <div id="stick"></div>
        </div>
        <div class="fire-btn" id="fire-trigger">FIRE</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- حماية إضافية من التكبير عبر JS ---
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault(); 
        }, { passive: false });

        let lastTouchTime = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchTime <= 300) e.preventDefault();
            lastTouchTime = now;
        }, false);

        // --- باقي كود اللعبة المستقر ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const joyBase = document.getElementById('joy-base');
        const stick = document.getElementById('stick');
        
        let score = 0;
        let enemies = [];
        let bullets = [];
        let gameActive = false;
        let moveDir = { x: 0, y: 0 };
        const keys = {};
        const player = { x: 0, y: 0, size: 15, speed: 5 };

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
        }
        window.addEventListener('resize', resize);
        resize();

        let isMoving = false;
        joyBase.onpointerdown = (e) => { isMoving = true; handleMove(e); };
        window.onpointermove = (e) => { if(isMoving) handleMove(e); };
        window.onpointerup = () => { 
            isMoving = false; 
            stick.style.transform = `translate(0,0)`;
            moveDir = { x: 0, y: 0 };
        };

        function handleMove(e) {
            const rect = joyBase.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            let dx = e.clientX - cx;
            let dy = e.clientY - cy;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const limit = 40;
            if(dist > limit) { dx *= limit/dist; dy *= limit/dist; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            moveDir = { x: dx/limit, y: dy/limit };
        }

        document.getElementById('fire-trigger').onpointerdown = (e) => {
            e.preventDefault();
            bullets.push({ x: player.x, y: player.y, vx: 0, vy: -10 });
        };

        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function startGame(type) {
            document.getElementById('start-screen').style.display = 'none';
            player.speed = (type === 'hacker') ? 7 : 4;
            gameActive = true;
        }

        function update() {
            if(!gameActive) return;
            if(keys['w']) player.y -= player.speed;
            if(keys['s']) player.y += player.speed;
            if(keys['a']) player.x -= player.speed;
            if(keys['d']) player.x += player.speed;
            player.x += moveDir.x * player.speed;
            player.y += moveDir.y * player.speed;

            if(Math.random() < 0.02) enemies.push({x: Math.random()*canvas.width, y: -20, s: 2});
            
            enemies.forEach((en, i) => {
                en.y += en.s;
                bullets.forEach((b, bi) => {
                    if(Math.hypot(b.x - en.x, b.y - en.y) < 20) {
                        enemies.splice(i, 1); bullets.splice(bi, 1);
                        score += 10; document.getElementById('score').innerText = "النقاط: " + score;
                    }
                });
            });
            bullets.forEach((b, i) => { b.y += b.vy; if(b.y < -50) bullets.splice(i,1); });
        }

        function draw() {
            ctx.fillStyle = 'black'; ctx.fillRect(0,0,canvas.width, canvas.height);
            if(!gameActive) return;
            ctx.fillStyle = '#00f2ff'; ctx.beginPath();
            ctx.arc(player.x, player.y, player.size, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'red'; enemies.forEach(en => ctx.fillRect(en.x, en.y, 20, 20));
            ctx.fillStyle = 'white'; bullets.forEach(b => ctx.fillRect(b.x, b.y, 4, 10));
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }
        loop();
    </script>
</body>
</html>
